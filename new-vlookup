import pandas as pd
from datetime import datetime
from openpyxl.styles import Font, Color, PatternFill

# Load the CSV and Excel files
data_df = pd.read_csv('data.csv')
excel_df = pd.read_excel('All Subs Netguru Report.xlsx', sheet_name='Azure')

# ... (rest of the code for processing data remains the same)

# Merge the dataframes on the 'Subscription ID' column
merged_df = pd.merge(excel_df, data_df[['Subscription ID', 'Compliance Status']], on='Subscription ID', how='left')

# Create a new column with today's date and fill with 'Compliance Status'
today_date = datetime.today().strftime('Status %m.%d.%Y')
merged_df[today_date] = merged_df['Compliance Status']

# Drop the extra 'Compliance Status' column used for merging
merged_df = merged_df.drop(columns=['Compliance Status'])

# Define conditional formatting rules
green_fill = PatternFill(start_color='FF90EE90', end_color='FF90EE90', fill_type='solid')
orange_fill = PatternFill(start_color='FFFFC7CE', end_color='FFFFC7CE', fill_type='solid')

compliance_rule = ('=($' + today_date + '="Compliant")')
non_compliance_rule = ('=($' + today_date + '="Non-Compliant")')

# Apply conditional formatting to the 'today_date' column
with pd.ExcelWriter('All Subs Netguru Report.xlsx', engine='openpyxl', mode='a', if_sheet_exists='replace') as writer:
    merged_df.to_excel(writer, sheet_name='Azure', index=False)
    worksheet = writer.sheets['Azure']

    # Create formatting objects
    green_format = Font(color=Color(rgb='006100'))  # Dark green font for better contrast
    green_format = green_format + green_fill
    orange_format = Font(color=Color(rgb='9C0000'))  # Dark red font for better contrast
    orange_format = orange_format + orange_fill

    # Apply conditional formatting rules
    conditional_formatting = worksheet.conditional_formatting.add_conditional_formatting(
        worksheet['A1:' + today_date + str(merged_df.shape[0])]
    )
    conditional_formatting.add_rule(compliance_rule, green_format)
    conditional_formatting.add_rule(non_compliance_rule, orange_format)

print(f"Data has been successfully updated with a new column '{today_date}' and conditional formatting applied.")
