import pandas as pd
from datetime import datetime
from openpyxl import load_workbook
from openpyxl.styles import PatternFill

# Load the CSV and Excel files
data_df = pd.read_csv('data.csv')
excel_df = pd.read_excel('All Subs Netguru Report.xlsx', sheet_name='Azure')

# Rename columns if there are leading/trailing spaces or case differences
data_df.columns = data_df.columns.str.strip()
excel_df.columns = excel_df.columns.str.strip()

# If the 'Subscription ID' column is named differently, rename it
if 'subscription id' in data_df.columns.str.lower():
    data_df.rename(columns={col: 'Subscription ID' for col in data_df.columns if col.lower() == 'subscription id'}, inplace=True)

if 'subscription id' in excel_df.columns.str.lower():
    excel_df.rename(columns={col: 'Subscription ID' for col in excel_df.columns if col.lower() == 'subscription id'}, inplace=True)

# Ensure both dataframes are in the same case for comparison
data_df['Subscription ID'] = data_df['Subscription ID'].str.lower()
excel_df['Subscription ID'] = excel_df['Subscription ID'].str.lower()

# Merge the dataframes on the 'Subscription ID' column
merged_df = pd.merge(excel_df, data_df[['Subscription ID', 'Compliance Status']], on='Subscription ID', how='left')

# Create a new column with the desired date format and fill with 'Compliance Status'
date_column_name = 'Status ' + datetime.today().strftime('%m-%d-%Y')
merged_df[date_column_name] = merged_df['Compliance Status']

# Drop the extra 'Compliance Status' column used for merging
merged_df = merged_df.drop(columns=['Compliance Status'])

# Load the Excel workbook
workbook = load_workbook('All Subs Netguru Report.xlsx')
worksheet = workbook['Azure']

# Define fill colors
green_fill = PatternFill(start_color='00FF00', end_color='00FF00', fill_type='solid')
orange_fill = PatternFill(start_color='FFA500', end_color='FFA500', fill_type='solid')
red_fill = PatternFill(start_color='FF0000', end_color='FF0000', fill_type='solid')

# Get the column index for the newly added column
new_col_idx = worksheet.max_column

# Find the previous day's column (if it exists)
prev_date_column = 'Status ' + (datetime.today() - pd.Timedelta(days=1)).strftime('%m-%d-%Y')
prev_col_idx = None

for col in range(1, new_col_idx):
    if worksheet.cell(row=1, column=col).value == prev_date_column:
        prev_col_idx = col
        break

# Iterate through the rows and apply formatting based on compliance status
for row_idx, row in enumerate(merged_df.itertuples(), start=2):
    current_status = getattr(row, date_column_name.replace(' ', '_'))
    cell = worksheet.cell(row=row_idx, column=new_col_idx)

    if current_status == 'Compliant':
        cell.fill = green_fill
    elif current_status == 'Non-Compliant':
        cell.fill = orange_fill

    # Compare with previous day's data and highlight in red if needed
    if prev_col_idx:
        prev_status = worksheet.cell(row=row_idx, column=prev_col_idx).value
        if prev_status != 'Non-Compliant' and current_status == 'Non-Compliant':
            cell.fill = red_fill

# Save the updated Excel file
workbook.save('All Subs Netguru Report.xlsx')

print(f"Data has been successfully updated with a new column '{date_column_name}' and formatted based on compliance status.")
